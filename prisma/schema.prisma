generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model ExternalIdentifier {
  id         Int      @id @default(autoincrement())
  provider   String
  providerId String
  entityType String
  entityId   Int?
  entityKey  String?
  url        String?
  meta       Json?
  lastSynced DateTime?

  @@unique([provider, providerId])
  @@index([entityType, entityId])
}

model Nation {
  id      Int     @id @default(autoincrement())
  name    String  @unique

  Leagues League[]
  Clubs   Club[]       // optional link if you model a nation team as a Club
  Players Player[]
}

model Season {
  id           Int             @id @default(autoincrement())
  name         String          @unique
  LeagueSeasons LeagueSeason[]

  @@map("seasons")
}

model League {
  id         Int            @id @default(autoincrement())
  name       String
  nationId   Int
  externalId String?        @unique

  nation      Nation       @relation(fields: [nationId], references: [id])
  leagueSeasons LeagueSeason[]
}

model LeagueSeason {
  id            Int       @id @default(autoincrement())
  leagueId      Int
  seasonId      Int
  externalId    String?   @unique

  league        League    @relation(fields: [leagueId], references: [id])
  season        Season    @relation(fields: [seasonId], references: [id])
  clubSeasons   ClubSeason[]
  matchWeeks    MatchWeek[]
  fixtures      Fixture[]

  @@unique([leagueId, seasonId])
}

model Club {
  id         Int         @id @default(autoincrement())
  name       String
  nationId   Int
  externalId String?     @unique

  nation      Nation     @relation(fields: [nationId], references: [id])
  clubSeasons ClubSeason[]
}

model ClubSeason {
  id             Int       @id @default(autoincrement())
  clubId         Int
  leagueSeasonId Int

  club           Club       @relation(fields: [clubId], references: [id])
  leagueSeason   LeagueSeason @relation(fields: [leagueSeasonId], references: [id])
  squads         SquadMembership[]
  fixturesHome   Fixture[]  @relation("FixtureHome")
  fixturesAway   Fixture[]  @relation("FixtureAway")
  transfersFrom  Transfer[] @relation("FromClubSeason")
  transfersTo    Transfer[] @relation("ToClubSeason")

  @@unique([clubId, leagueSeasonId])
}

model Player {
  id              Int       @id @default(autoincrement())
  firstName       String
  lastName        String
  displayName     String?
  dateOfBirth     DateTime?
  birthPlace      String?
  nationalityId   Int?
  age             Int?
  currentMV       Float?
  shirtNumber     Int?
  transferDate    DateTime?
  prevClub        String?
  prevMV          Float?
  transferFee     String?
  status          String?
  contractExpiry  DateTime?
  heightCm        Int?
  weightKg        Int?
  position        String?
  transfermarktId String?   @unique
  externalId      String?   @unique

  nationality     Nation?   @relation(fields: [nationalityId], references: [id])
  squads          SquadMembership[]
  transfers       Transfer[]
}

model SquadMembership {
  id            Int       @id @default(autoincrement())
  clubSeasonId  Int
  playerId      Int
  shirtNumber   Int?

  clubSeason    ClubSeason @relation(fields: [clubSeasonId], references: [id])
  player        Player     @relation(fields: [playerId], references: [id])

  @@unique([clubSeasonId, playerId])
}

model Transfer {
  id               Int       @id @default(autoincrement())
  playerId         Int
  fromClubSeasonId Int?
  toClubSeasonId   Int?
  date             DateTime
  fee              String?
  marketValue      Float?

  player           Player     @relation(fields: [playerId], references: [id])
  fromClubSeason   ClubSeason? @relation("FromClubSeason", fields: [fromClubSeasonId], references: [id])
  toClubSeason     ClubSeason? @relation("ToClubSeason", fields: [toClubSeasonId], references: [id])

  @@unique([playerId, toClubSeasonId, date])
}

model MatchWeek {
  id             Int        @id @default(autoincrement())
  leagueSeasonId Int
  weekNumber     Int
  fixtures       Fixture[]
  leagueSeason   LeagueSeason @relation(fields: [leagueSeasonId], references: [id])

  @@unique([leagueSeasonId, weekNumber])
}

model Fixture {
  id              Int        @id @default(autoincrement())
  leagueSeasonId  Int
  weekNumber      Int?
  matchWeekId     Int?
  date            DateTime?
  notes           String?
  homeClubSeasonId Int
  awayClubSeasonId Int
  homeTeamName    String?
  awayTeamName    String?
  homeScore       Int?
  awayScore       Int?
  homeXg          Float?
  awayXg          Float?
  homeFormation   String?
  awayFormation   String?

  leagueSeason    LeagueSeason @relation(fields: [leagueSeasonId], references: [id])
  matchWeek       MatchWeek?   @relation(fields: [matchWeekId], references: [id], onDelete: Cascade)
  homeClubSeason  ClubSeason   @relation("FixtureHome", fields: [homeClubSeasonId], references: [id])
  awayClubSeason  ClubSeason   @relation("FixtureAway", fields: [awayClubSeasonId], references: [id])
  matchStats      FixtureMatchStats?
  events          MatchEvent[]
  gkPerf          GkPerf?
}

model FixtureMatchStats {
  id                Int     @id @default(autoincrement())
  fixtureId         Int     @unique
  notes             String?
  homePossession    Float?
  awayPossession    Float?
  homeXG            Float?
  awayXG            Float?
  homeBigChance     Int?
  awayBigChance     Int?
  homeShots         Int?
  awayShots         Int?
  homeSaves         Int?
  awaySaves         Int?
  homeCriticalSaves Int?
  awayCriticalSaves Int?
  homeGKPerf        Float?
  awayGKPerf        Float?
  homeCorners       Int?
  awayCorners       Int?
  homeFouls         Int?
  awayFouls         Int?
  homePasses        Int?
  awayPasses        Int?
  homeInterceptions Int?
  awayInterceptions Int?
  homeFKs           Int?
  awayFKs           Int?
  homeYellowCards   Int?
  awayYellowCards   Int?
  homeRedCards      Int?
  awayRedCards      Int?
  homePenaltyXG     Int?
  awayPenaltyXG     Int?
  homeshotsOnTarget Int?
  awayshotsOnTarget Int?
  homeShotPct       Int?
  awayShotPct       Int?
  homePosts         Int?
  awayPosts         Int?
  homeShotOffTarget Int?
  awayShotOffTarget Int?
  homeBlockedShots  Int?
  awayBlockedShots  Int?
  homeShotsInBox    Int?
  awayShotsInBox    Int?
  homeShotsInBoxPct Int?
  awayShotsInBoxPct Int?
  homeShotsOutBox   Int?
  awayShotsOutBox   Int?
  homeShotsOutBoxPct Int?
  awayShotsOutBoxPct Int?
  homeErrorToShot   Float?
  awayErrorToShot   Float?
  homeErrorToGoal   Float?
  awayErrorToGoal   Float?

  fixture Fixture @relation(fields: [fixtureId], references: [id])
}

model MatchEvent {
  id              Int      @id @default(autoincrement())
  fixtureId       Int
  minute          Int?
  minuteStr       String?
  eventType       String?
  teamId          Int?
  playerId        Int?
  teamName        String?
  playerFirstName String?
  playerLastName  String?
  playerPos       String?
  playerRating    Int?
  shotArea        String?
  shotType        String?
  eventLeadUp     String?
  xG              Float?
  xGOT            Float?
  bigChance       Boolean?
  outcome         String?
  score           String?
  aPlayerFN       String?
  aPlayerLN       String?

  fixture Fixture @relation(fields: [fixtureId], references: [id], onDelete: Cascade)
  @@unique([fixtureId, minuteStr, teamId, playerId, shotArea, shotType, eventLeadUp, xG, outcome])
}

model GkPerf {
  id           Int   @id @default(autoincrement())
  fixtureId    Int   @unique
  homeGkFn     String?
  homeGkLn     String?
  awayGkFn     String?
  awayGkLn     String?
  homeGkRating Int?
  awayGkRating Int?
  homeGkSaves  Int?
  awayGkSaves  Int?

  fixture Fixture @relation(fields: [fixtureId], references: [id], onDelete: Cascade)
}

